<!DOCTYPE html>
<html lang="en">
<head>
  <script>
  (function checkAccess() {
    const token = localStorage.getItem("token");
    const role = localStorage.getItem("userRole");
    if (!token) { alert("‚ö†Ô∏è Login required."); window.location.href = "index.html"; return; }
    if (role !== "issuer") { alert("‚õî Access Denied"); window.location.href = "index.html"; return; }
  })();
  function logout() { localStorage.clear(); window.location.href = "index.html"; }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.0/dist/ethers.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="blockchain.js"></script>

  <meta charset="UTF-8">
  <title>Issuer Dashboard</title>
  <style>
    /* PREVIOUS CSS (Kept same for consistency) */
    body { font-family: "Times New Roman", Times, serif; background-color: #f4f1ea; color: #333; padding: 40px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
    h2 { text-transform: uppercase; letter-spacing: 2px; border-bottom: 3px double #333; padding-bottom: 15px; margin-bottom: 40px; }
    .box { background: #fff; padding: 30px; width: 450px; border: 1px solid #c0c0c0; box-shadow: 5px 10px 15px rgba(0,0,0,0.1); text-align: center; }
    button { background-color: #2c3e50; color: white; border: 1px solid #1a252f; padding: 10px 25px; cursor: pointer; margin-top: 10px; }
    button:hover { background-color: #1a252f; }
    
    /* NEW CSS for QR Section */
    #qrSection { display: none; margin-top: 20px; border-top: 1px dashed #999; padding-top: 20px; }
    #qrcode { margin-top: 15px; display: flex; justify-content: center; }
  </style>
</head>
<body>
  <h2>üèõÔ∏è Authority Dashboard</h2>
  <button onclick="logout()" style="background: #c0392b;">Logout</button>  
  
  <div class="box">
    <h3>Document Submission</h3>
    <input type="file" id="uploadFile" />
    <br>
    <button onclick="uploadDocument()">Upload & Store</button>
    <p id="uploadResult" style="background:#f9f9f9; padding:10px; margin-top:10px;">Waiting for input...</p>

    <div id="qrSection">
      <h4>üéâ Verification Link Ready</h4>
      <p>Do you want to generate a QR code for this document?</p>
      <button onclick="generateQR()">Yes, Generate QR</button>
      <div id="qrcode"></div>
    </div>
  </div>

<script>
  const API_URL = "http://localhost:5000/api";
  let currentDocHash = ""; // Store hash globally to use in QR generation

  async function uploadDocument() {
    const fileInput = document.getElementById("uploadFile");
    const resultText = document.getElementById("uploadResult");
    const qrSection = document.getElementById("qrSection");

    // Reset UI
    qrSection.style.display = "none";
    document.getElementById("qrcode").innerHTML = ""; // Clear old QR

    if (!fileInput.files.length) { alert("Please select a file"); return; }
    
    resultText.innerText = "Processing...";

    const formData = new FormData();
    formData.append("document", fileInput.files[0]);
    const token = localStorage.getItem("token");

    try {
      const res = await fetch(`${API_URL}/upload`, {
        method: "POST",
        headers: { "Authorization": `Bearer ${token}` },
        body: formData
      });

      if (res.status === 401) { alert("Session expired."); logout(); return; }
      const data = await res.json();
      if (!res.ok) throw new Error(data.message);

      resultText.innerText = "Hash Generated. Storing on Blockchain...";
      
      // Store on Blockchain
      await storeHashOnBlockchain(data.hash); 
      
      // Success!
      resultText.innerText = "‚úÖ Success! Hash: " + data.hash;
      currentDocHash = data.hash; // Save hash for QR Code
      qrSection.style.display = "block"; // Show the "Do you want QR" prompt

    } catch (err) {
      console.error(err);
      resultText.innerText = "Error: " + err.message;
    }
  }
function generateQR() {
    if (!currentDocHash) return;
    
    // üü¢ FIX: Use 'replace' to keep the current folder path (e.g., /frontend/)
    // If you are at ".../frontend/issuer.html", this makes ".../frontend/scan.html"
    let baseUrl = window.location.href.split('?')[0]; // Remove any existing params
    baseUrl = baseUrl.substring(0, baseUrl.lastIndexOf('/') + 1); // Get folder path
    const verificationLink = `${baseUrl}scan.html?hash=${currentDocHash}`;
    
    console.log("QR Link:", verificationLink);
    
    // Generate QR
    const qrContainer = document.getElementById("qrcode");
    qrContainer.innerHTML = ""; // Clear previous
    new QRCode(qrContainer, {
      text: verificationLink,
      width: 128,
      height: 128
    });
  }
</script>
</body>
</html>